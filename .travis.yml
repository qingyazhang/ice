sudo: true
language: generic
dist: trusty
group: travis_latest

env:
  global:
  - DOCKER_BASE_TAG=3.7-ubuntu-16.04
  - DOCKER_BASE_IMAGE=zerocci/ice-base:${DOCKER_BASE_TAG}
  - DOCKER_BUILD_IMAGE=zerocci/ice-travis-build:${TRAVIS_BUILD_NUMBER}
  - MAKEFLAGS="-j3 V=1 OPTIMIZE=no USER_NAMESPACES=no CONFIGS=shared"
  - DOCKER_RUN="docker run -it --rm ${DOCKER_BUILD_IMAGE} /bin/bash -c"
  - ALLTESTS="python allTests.py --protocol=ssl --workers=4"

jobs:
  include:
    - stage: build docker image
      script:
      # see https://github.com/travis-ci/travis-ci/issues/8920#issuecomment-353133953 for fcntl issue
      - python -c "import fcntl; fcntl.fcntl(1, fcntl.F_SETFL, 0)"
      - docker login --username "${DOCKER_USERNAME}" --password "${DOCKER_PASSWORD}"
      - |
        echo "FROM ${DOCKER_BASE_IMAGE}" >> Dockerfile
        echo "RUN make ${MAKEFLAGS}" >> Dockerfile
      - docker build --cache-from ${DOCKER_BASE_IMAGE} -t ${DOCKER_BUILD_IMAGE} .
      - docker push ${DOCKER_BUILD_IMAGE}

    - &test-staging
      stage: test staging
      before_script:
      # see https://github.com/travis-ci/travis-ci/issues/8920#issuecomment-353133953 for fcntl issue
      - python -c "import fcntl; fcntl.fcntl(1, fcntl.F_SETFL, 0)"
      - docker pull ${DOCKER_BUILD_IMAGE}
      script: $DOCKER_RUN "${ALLTESTS} --filter=cpp"
      env: comment=C++
    - <<: *test-staging
      script: $DOCKER_RUN "cd cpp; make ${MAKEFLAGS} CONFIGS='shared cpp11-shared'; ${ALLTESTS}"
      env: comment=C++11
    - <<: *test-staging
      script: $DOCKER_RUN "${ALLTESTS} --filter=java"
      env: comment=Java
    - <<: *test-staging
      script: $DOCKER_RUN "${ALLTESTS} --filter=java-compat"
      env: comment=Java Compat
    - <<: *test-staging
      script: $DOCKER_RUN "${ALLTESTS} --filter=js"
      env: comment=JavaScript
    - <<: *test-staging
      script: $DOCKER_RUN "${ALLTESTS} --filter=php"
      env: comment=PHP
    - <<: *test-staging
      script: $DOCKER_RUN "${ALLTESTS} --filter=python"
      env: comment=Python
    - <<: *test-staging
      script: $DOCKER_RUN "${ALLTESTS} --filter=ruby"
      env: comment=Ruby

notifications:
  email: travis-ci@zeroc.com
  slack:
    secure: TywLzzH1Hx3Pb5I4s4wxbEZ9nOAPkamZDqHBOkpLSNSRa2iSk6n5GcQi5bnw0Ct59oTEytO/8fNP6mYwf5G2rrXGWpcdgSdyLMcUk6ASeO7ANv7xLKhVWbbOoVuZxFJvIG5mTYpCa3R58EtchQErzdyf3rRMN3rq/ZBmocFMcRY=
